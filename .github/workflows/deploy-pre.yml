name: CD Preprod (Coolify - frontend)

on:
  push:
    branches: [ preprod ]   # d√©clenche √† chaque push sur preprod

permissions:
  contents: read

concurrency:
  group: cd-preprod-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy frontend (preprod) via Coolify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ‚ö° D√©clenche le d√©ploiement via l'API Coolify
      - name: Trigger Coolify deploy
        env:
          COOLIFY_API_TOKEN:   ${{ secrets.COOLIFY_API_TOKEN }}
          COOLIFY_SERVICE_UUID: ${{ secrets.COOLIFY_FRONT_PREPROD_UUID }}
        run: |
          set -euo pipefail
          BASE_URL="http://coolify.cyber-dodo.fr/api/v1"
          echo "üöÄ D√©ploiement en cours sur Coolify (frontend pr√©prod)‚Ä¶"
          curl -fsS -X POST "${BASE_URL}/deploy?uuid=${COOLIFY_SERVICE_UUID}&force=false" \
            -H "Authorization: Bearer ${COOLIFY_API_TOKEN}" \
            -H "Content-Type: application/json"
          echo "‚úÖ D√©ploiement d√©clench√© (sans attente du build)."
